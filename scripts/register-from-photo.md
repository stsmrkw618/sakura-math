# 写真から問題登録

## テスト写真の保存場所

テスト用紙の写真は以下のフォルダ構造で管理する:

```
problem/
├── 2026-01/          # 2026年1月のテスト
│   ├── xxxxxxxx.jpg
│   └── ...
├── 2026-02/          # 2026年2月のテスト
│   ├── 20260222_131719.jpg
│   └── 20260222_131729.jpg
└── YYYY-MM/          # テスト実施月でフォルダを分ける
```

- フォルダ名: `YYYY-MM` 形式（テスト実施月）
- 写真ファイル: スマホ撮影のまま（ファイル名は任意）
- このフォルダは `.gitignore` でGit管理対象外

## 全体フロー

```
写真読み取り → 1問ずつレビュー → 図形ヒアリング → 全問OK → JSON書き込み → ビルド → コミット
                  ↑ 修正指示 ↓
                  ←←←←←←←←←←
```

## Phase 1: 読み取りと下準備

1. 画像から問題文を読み取る
2. ユーザーが指定した問題番号の問題を抽出する
3. 各問題について分析:
   - tags: data/problems.json の tags 定義から1〜3個選択
   - difficulty: 基礎 / 標準 / 発展
   - stumblingPoint: 小学生がつまずきやすいポイント（1-2文）
4. 答えと解き方を作成（小学生向けの丁寧な解説）
5. ID採番: 既存の最大ID + 1（"YYYY-MM-NNN"形式。YYYYとMMはテスト実施月に合わせる）

## Phase 2: 1問ずつレビュー（★最重要）

**JSONに書き込む前に、必ず1問ずつユーザーに確認を取る。**

### 提示フォーマット

各問題を以下の形式で提示する:

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📝 問題の確認（1/○）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━

【大問○(○)】ID: 2026-XX-NNN
正答率: ○○% → ドリル/ハイレベル
タグ: ○○, ○○ | 難易度: ○○

■ 問題文:
「（読み取った問題文をそのまま表示）」

■ 図形: あり / なし
  → ありの場合: 「この問題には図が必要です。トリミングした画像を添付してください。」

■ 答え・解説:
（生成した模範解答と解き方）

■ つまずきポイント:
（生成したつまずきポイント）

━━━━━━━━━━━━━━━━━━━━━━━━━━━━
→ 問題文・答えは正しいですか？ 図形はありますか？
  修正があれば指示してください。OKならそのまま次へ進みます。
━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### 確認のポイント

各問題の提示時に、以下を必ず実行する:

1. **問題文**: OCR読み取り結果をそのまま表示（推測補完しない）
2. **図形の有無をヒアリング**: 図がある問題かどうかをユーザーに確認する
3. **答え・解説**: 解法の正しさをユーザーが確認できるよう、途中式も含めて表示
4. **振り分け先**: 正答率に基づくドリル/ハイレベルの振り分けを明示

### 図形画像の受け取り

- **Claude Codeは図形のトリミングを行わない**（精度が不十分なため）
- 図がある問題では、ユーザーにトリミング済み画像の添付を依頼する
- ユーザーから画像を受け取ったら:
  1. sharpでPNG変換し `public/figures/{問題ID}.png` に保存
  2. `Read` ツールで保存した画像を表示し、正しく保存されたことを確認
  3. `figure.description` を画像内容から生成
- 同じ大問の小問が同じ図を使う場合は、同じ画像ファイルを共有する

### OCRで特にミスが起きやすい箇所

- **数字**: 1↔2, 6↔8, 3↔5 など（数字1つの違いで答えが変わる）
- **小問番号の対応**: (1)(2)(3)の問題文が正しい小問番号に紐づいているか
- **連立問題の前提関係**: 大問の(1)(2)(3)が互いに参照し合う場合
- **選択肢・条件の読み落とし**: 「0以外の整数で」等の追加条件
- **写真の不鮮明さ**: 読み取れない箇所は推測せず「この箇所が読み取れません」と正直に伝える

### 修正対応

- ユーザーから修正指示があった場合、修正内容を反映して**その問題だけ再提示**する
- 修正後の再提示でもOKが出るまで次の問題に進まない

## Phase 3: 登録

全問のレビューが完了してから:

1. `data/problems.json` に追記
2. `npm run build` でビルド検証
3. ユーザーに完了報告

## 注意
- 問題文は原文のまま忠実に転記する（誤字修正はしない）
- 図形問題は図の情報を漏れなくテキスト化する
- 解き方は小4が理解できるレベルの説明にする
- **写真の角度や印刷の不鮮明さで読み取りにくい場合は、推測せず「この箇所が読み取れません」と正直に伝える**
